<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>接口测试平台</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="app">
        <!-- 顶部导航栏 -->
        <header class="navbar">
            <div class="navbar-brand">
                <i class="fas fa-flask"></i>
                <span>接口测试平台</span>
            </div>
            <div class="navbar-menu">
                <a href="#" class="nav-item" @click.prevent="currentPage = 'collections'">
                    <i class="fas fa-folder"></i> 集合
                </a>
                <a href="#" class="nav-item" @click.prevent="currentPage = 'request'">
                    <i class="fas fa-envelope"></i> 请求
                </a>
                <a href="#" class="nav-item" @click.prevent="currentPage = 'environments'">
                    <i class="fas fa-cog"></i> 环境
                </a>
                <a href="#" class="nav-item" @click.prevent="currentPage = 'reports'">
                    <i class="fas fa-chart-bar"></i> 报告
                </a>
            </div>
            <div class="navbar-right">
                <div class="environment-selector">
                    <select v-model="selectedEnvironment" @change="onEnvironmentChange">
                        <option :value="null">-- 选择环境 --</option>
                        <option v-for="env in environments" :key="env.id" :value="env">
                            {{ env.name }}
                        </option>
                    </select>
                </div>
            </div>
        </header>

        <!-- 主内容区域 -->
        <main class="main-container">
            <!-- 1. 集合视图 -->
            <section v-if="currentPage === 'collections'" class="page collections-page">
                <div class="page-header">
                    <h1>测试集合</h1>
                    <button @click="showCollectionModal = true" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新建集合
                    </button>
                </div>

                <div class="collections-list">
                    <div v-if="collections.length === 0" class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <p>暂无集合，请创建新集合</p>
                    </div>
                    
                    <div v-for="collection in collections" :key="collection.id" class="collection-card">
                        <div class="collection-header">
                            <h3>{{ collection.name }}</h3>
                            <div class="collection-actions">
                                <button @click="editCollection(collection)" class="btn-icon" title="编辑">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteCollection(collection.id)" class="btn-icon danger" title="删除">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="collection-description">{{ collection.description }}</p>
                        <div class="collection-meta">
                            <span><i class="fas fa-envelope"></i> {{ collection.request_count }} 个请求</span>
                            <span><i class="fas fa-calendar"></i> {{ formatDate(collection.created_at) }}</span>
                        </div>
                        <div class="collection-footer">
                            <button @click="openCollection(collection.id)" class="btn btn-sm btn-secondary">
                                <i class="fas fa-folder-open"></i> 打开
                            </button>
                            <button @click="runCollection(collection.id)" class="btn btn-sm btn-success">
                                <i class="fas fa-play"></i> 运行测试
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 2. 请求编辑视图 -->
            <section v-if="currentPage === 'request'" class="page request-page">
                <div class="page-header">
                    <h1>请求编辑</h1>
                </div>

                <div class="request-layout">
                    <!-- 左侧：集合和请求列表 -->
                    <aside class="sidebar">
                        <div class="sidebar-section">
                            <h3>集合</h3>
                            <div class="collections-tree">
                                <div v-if="collections.length === 0" class="empty-state-small">
                                    暂无集合
                                </div>
                                <div v-for="collection in collections" :key="collection.id" class="tree-item">
                                    <div class="tree-item-header" 
                                         @click="toggleCollectionExpanded(collection.id)">
                                        <i :class="['fas', expandedCollections.includes(collection.id) ? 'fa-chevron-down' : 'fa-chevron-right']"></i>
                                        <span>{{ collection.name }}</span>
                                    </div>
                                    <div v-if="expandedCollections.includes(collection.id)" class="tree-item-children">
                                        <div v-if="collection.requests.length === 0" class="tree-empty">
                                            暂无请求
                                        </div>
                                        <div v-for="req in collection.requests" :key="req.id" 
                                             @click="selectRequest(collection.id, req.id)"
                                             :class="['tree-item-child', {active: currentRequest && currentRequest.id === req.id}]">
                                            <span :class="['method-badge', req.method.toLowerCase()]">{{ req.method }}</span>
                                            <span class="request-name">{{ req.name }}</span>
                                        </div>
                                        <button @click="addRequest(collection.id)" class="btn-add-request">
                                            <i class="fas fa-plus"></i> 添加请求
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </aside>

                    <!-- 右侧：请求编辑器 -->
                    <div class="editor-panel">
                        <div v-if="!currentRequest" class="editor-empty">
                            <i class="fas fa-mouse"></i>
                            <p>请从左侧选择请求开始编辑</p>
                        </div>

                        <div v-else class="request-editor">
                            <div class="editor-header">
                                <div class="request-name-input">
                                    <input v-model="currentRequest.name" type="text" placeholder="请求名称">
                                </div>
                            </div>

                            <div class="request-url-bar">
                                <select v-model="currentRequest.method" class="method-select">
                                    <option>GET</option>
                                    <option>POST</option>
                                    <option>PUT</option>
                                    <option>DELETE</option>
                                    <option>PATCH</option>
                                    <option>HEAD</option>
                                    <option>OPTIONS</option>
                                </select>
                                <input v-model="currentRequest.url" type="text" placeholder="http://api.example.com/path" class="url-input">
                                <button @click="sendRequest" class="btn btn-primary">
                                    <i class="fas fa-paper-plane"></i> 发送
                                </button>
                            </div>

                            <!-- 标签页 -->
                            <div class="tabs">
                                <div class="tab-header">
                                    <button :class="['tab-btn', {active: requestTab === 'headers'}]" 
                                            @click="requestTab = 'headers'">
                                        Headers
                                    </button>
                                    <button :class="['tab-btn', {active: requestTab === 'body'}]" 
                                            @click="requestTab = 'body'">
                                        Body
                                    </button>
                                    <button :class="['tab-btn', {active: requestTab === 'params'}]" 
                                            @click="requestTab = 'params'">
                                        Params
                                    </button>
                                    <button :class="['tab-btn', {active: requestTab === 'response'}]" 
                                            @click="requestTab = 'response'">
                                        Response
                                    </button>
                                </div>

                                <!-- Headers 标签页 -->
                                <div v-if="requestTab === 'headers'" class="tab-content">
                                    <div class="key-value-editor">
                                        <div class="kv-header">
                                            <span class="kv-key">Key</span>
                                            <span class="kv-value">Value</span>
                                            <span class="kv-action">Action</span>
                                        </div>
                                        <div v-for="(value, key, index) in (currentRequest.headers || {})" :key="index" class="kv-row">
                                            <input v-model="currentRequest.headers[key]" type="text" :placeholder="`Key ${index + 1}`">
                                            <input v-model="currentRequest.headers[key]" type="text" :placeholder="`Value ${index + 1}`">
                                            <button @click="deleteHeader(key)" class="btn-delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <button @click="addHeader" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-plus"></i> 添加 Header
                                        </button>
                                    </div>
                                </div>

                                <!-- Body 标签页 -->
                                <div v-if="requestTab === 'body'" class="tab-content">
                                    <div class="body-editor">
                                        <div class="editor-toolbar">
                                            <label>Body 类型：</label>
                                            <select v-model="currentRequest.bodyType" class="body-type-select">
                                                <option value="json">JSON</option>
                                                <option value="xml">XML</option>
                                                <option value="form">Form Data</option>
                                                <option value="raw">Raw</option>
                                            </select>
                                        </div>
                                        <textarea v-model="currentRequest.bodyText" 
                                                  class="body-textarea"
                                                  placeholder="Enter request body here..."></textarea>
                                    </div>
                                </div>

                                <!-- Params 标签页 -->
                                <div v-if="requestTab === 'params'" class="tab-content">
                                    <div class="key-value-editor">
                                        <div class="kv-header">
                                            <span class="kv-key">Key</span>
                                            <span class="kv-value">Value</span>
                                            <span class="kv-action">Action</span>
                                        </div>
                                        <div v-for="(value, key, index) in (currentRequest.params || {})" :key="index" class="kv-row">
                                            <input v-model="Object.keys(currentRequest.params)[index]" type="text" placeholder="Parameter Key">
                                            <input v-model="currentRequest.params[key]" type="text" placeholder="Parameter Value">
                                            <button @click="deleteParam(key)" class="btn-delete">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <button @click="addParam" class="btn btn-sm btn-secondary">
                                            <i class="fas fa-plus"></i> 添加参数
                                        </button>
                                    </div>
                                </div>

                                <!-- Response 标签页 -->
                                <div v-if="requestTab === 'response'" class="tab-content">
                                    <div v-if="!currentResponse" class="response-empty">
                                        <i class="fas fa-inbox"></i>
                                        <p>还未发送请求</p>
                                    </div>
                                    <div v-else class="response-viewer">
                                        <div class="response-meta">
                                            <span :class="['status-badge', currentResponse.status_code >= 200 && currentResponse.status_code < 300 ? 'success' : 'error']">
                                                {{ currentResponse.status_code }}
                                            </span>
                                            <span>{{ currentResponse.time }}s</span>
                                        </div>
                                        <div class="response-body">
                                            <pre>{{ formatJson(currentResponse.body) }}</pre>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="editor-footer">
                                <button @click="saveRequest" class="btn btn-primary">
                                    <i class="fas fa-save"></i> 保存
                                </button>
                                <button @click="deleteCurrentRequest" class="btn btn-danger">
                                    <i class="fas fa-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 3. 环境配置视图 -->
            <section v-if="currentPage === 'environments'" class="page environments-page">
                <div class="page-header">
                    <h1>环境配置</h1>
                    <button @click="showEnvironmentModal = true" class="btn btn-primary">
                        <i class="fas fa-plus"></i> 新建环境
                    </button>
                </div>

                <div class="environments-list">
                    <div v-if="environments.length === 0" class="empty-state">
                        <i class="fas fa-cog"></i>
                        <p>暂无环境配置</p>
                    </div>

                    <div v-for="env in environments" :key="env.id" class="environment-card">
                        <div class="env-header">
                            <h3>{{ env.name }}</h3>
                            <div class="env-actions">
                                <button @click="editEnvironment(env)" class="btn-icon">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button @click="deleteEnvironment(env.id)" class="btn-icon danger">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="env-info">
                            <p><strong>Base URL:</strong> {{ env.base_url }}</p>
                            <p v-if="env.headers" class="env-headers">
                                <strong>Headers:</strong> {{ Object.keys(env.headers).length }} 个
                            </p>
                            <p v-if="env.variables" class="env-variables">
                                <strong>Variables:</strong> {{ Object.keys(env.variables).length }} 个
                            </p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- 4. 报告视图 -->
            <section v-if="currentPage === 'reports'" class="page reports-page">
                <div class="page-header">
                    <h1>测试报告</h1>
                    <button @click="refreshReports" class="btn btn-secondary">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                </div>

                <div class="reports-list">
                    <div v-if="reports.length === 0" class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>暂无测试报告</p>
                    </div>

                    <div v-for="report in reports" :key="report.name" class="report-card">
                        <h3>{{ report.name }}</h3>
                        <p class="report-date">{{ formatDate(report.created) }}</p>
                        <a :href="report.path" target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link"></i> 查看报告
                        </a>
                    </div>
                </div>
            </section>
        </main>

        <!-- 模态框：创建/编辑集合 -->
        <div v-if="showCollectionModal" class="modal-overlay" @click="showCollectionModal = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h2>{{ editingCollection ? '编辑集合' : '创建新集合' }}</h2>
                    <button @click="showCollectionModal = false" class="btn-close">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>集合名称</label>
                        <input v-model="collectionForm.name" type="text" placeholder="输入集合名称">
                    </div>
                    <div class="form-group">
                        <label>描述</label>
                        <textarea v-model="collectionForm.description" placeholder="输入集合描述"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="showCollectionModal = false" class="btn btn-secondary">取消</button>
                    <button @click="saveCollection" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>

        <!-- 模态框：创建/编辑环境 -->
        <div v-if="showEnvironmentModal" class="modal-overlay" @click="showEnvironmentModal = false">
            <div class="modal" @click.stop>
                <div class="modal-header">
                    <h2>{{ editingEnvironment ? '编辑环境' : '创建新环境' }}</h2>
                    <button @click="showEnvironmentModal = false" class="btn-close">×</button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>环境名称</label>
                        <input v-model="environmentForm.name" type="text" placeholder="如：Dev, Test, Prod">
                    </div>
                    <div class="form-group">
                        <label>Base URL</label>
                        <input v-model="environmentForm.base_url" type="text" placeholder="https://api.example.com">
                    </div>
                    <div class="form-group">
                        <label>Headers (JSON)</label>
                        <textarea v-model="environmentForm.headersText" placeholder='{"Content-Type": "application/json"}'></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button @click="showEnvironmentModal = false" class="btn btn-secondary">取消</button>
                    <button @click="saveEnvironment" class="btn btn-primary">保存</button>
                </div>
            </div>
        </div>

        <!-- 加载中提示 -->
        <div v-if="loading" class="loading-overlay">
            <div class="spinner"></div>
            <p>加载中...</p>
        </div>

        <!-- 通知提示 -->
        <div v-if="notification" :class="['notification', notification.type]">
            <i :class="notification.icon"></i>
            <span>{{ notification.message }}</span>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.prod.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
